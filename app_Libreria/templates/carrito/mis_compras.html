<!-- app_Libreria/templates/carrito/mis_compras.html -->
{% extends 'base.html' %}

{% block content %}
<div class="container">
    <header class="page-header">
        <div class="header-content">
            <div class="header-icon">üì¶</div>
            <h1>Mis Compras</h1>
            <p class="subtitle">Historial de todas tus compras realizadas</p>
        </div>
        <div class="header-actions">
            <button class="btn-filter" id="filterToggle">
                <svg class="icon" viewBox="0 0 24 24" width="20" height="20">
                    <path d="M10 18h4v-2h-4v2zM3 6v2h18V6H3zm3 7h12v-2H6v2z"/>
                </svg>
                Filtrar
            </button>
            <button class="btn-export" onclick="exportToCSV()">
                <svg class="icon" viewBox="0 0 24 24" width="20" height="20">
                    <path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/>
                </svg>
                Exportar
            </button>
        </div>
    </header>

    <!-- Filtros (inicialmente ocultos) -->
    <div class="filters-container" id="filtersPanel">
        <div class="filters-grid">
            <div class="filter-group">
                <label for="filterStatus">Estado</label>
                <select id="filterStatus" class="filter-select">
                    <option value="all">Todos los estados</option>
                    <option value="COMPLETADA">Completadas</option>
                    <option value="PENDIENTE">Pendientes</option>
                    <option value="CANCELADA">Canceladas</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="filterMonth">Mes</label>
                <select id="filterMonth" class="filter-select">
                    <option value="all">Todos los meses</option>
                    <option value="1">Enero</option>
                    <option value="2">Febrero</option>
                    <option value="3">Marzo</option>
                    <option value="4">Abril</option>
                    <option value="5">Mayo</option>
                    <option value="6">Junio</option>
                    <option value="7">Julio</option>
                    <option value="8">Agosto</option>
                    <option value="9">Septiembre</option>
                    <option value="10">Octubre</option>
                    <option value="11">Noviembre</option>
                    <option value="12">Diciembre</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="sortOrder">Ordenar por</label>
                <select id="sortOrder" class="filter-select">
                    <option value="newest">M√°s recientes primero</option>
                    <option value="oldest">M√°s antiguas primero</option>
                    <option value="total_high">Total: Mayor a menor</option>
                    <option value="total_low">Total: Menor a mayor</option>
                </select>
            </div>
            <div class="filter-actions">
                <button class="btn-apply" onclick="applyFilters()">Aplicar Filtros</button>
                <button class="btn-reset" onclick="resetFilters()">Limpiar</button>
            </div>
        </div>
    </div>

    {% if ventas %}
    <!-- Estad√≠sticas -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon">üí∞</div>
            <div class="stat-content">
                <h3>Total Gastado</h3>
                <p class="stat-value">${{ total_gastado|default:"0.00"|floatformat:2 }}</p>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">üìä</div>
            <div class="stat-content">
                <h3>Compras Totales</h3>
                <p class="stat-value">{{ ventas.count }}</p>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">üìö</div>
            <div class="stat-content">
                <h3>Libros Comprados</h3>
                <p class="stat-value">{{ total_libros|default:"0" }}</p>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">‚≠ê</div>
            <div class="stat-content">
                <h3>√öltima Compra</h3>
                <p class="stat-value">{{ ultima_compra|date:"d/m/Y"|default:"N/A" }}</p>
            </div>
        </div>
    </div>

    <!-- Tabla de compras -->
    <div class="table-container">
        <div class="table-responsive">
            <table class="purchases-table" id="purchasesTable">
                <thead>
                    <tr>
                        <th class="text-left">
                            <span>ID Venta</span>
                            <button class="sort-btn" data-sort="id">‚Üï</button>
                        </th>
                        <th>
                            <span>Fecha</span>
                            <button class="sort-btn" data-sort="date">‚Üï</button>
                        </th>
                        <th>
                            <span>Total</span>
                            <button class="sort-btn" data-sort="total">‚Üï</button>
                        </th>
                        <th>M√©todo Pago</th>
                        <th>Estado</th>
                        <th class="text-center">Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for venta in ventas %}
                    <tr class="purchase-row" 
                        data-status="{{ venta.estadoventa }}"
                        data-date="{{ venta.fechaventa|date:'Y-m-d' }}"
                        data-total="{{ venta.montototal }}"
                        data-id="{{ venta.ventaid }}">
                        <td class="purchase-id">#{{ venta.ventaid }}</td>
                        <td class="purchase-date">{{ venta.fechaventa|date:"d M Y H:i" }}</td>
                        <td class="purchase-total">${{ venta.montototal|floatformat:2 }}</td>
                        <td class="purchase-method">
                            <div class="method-badge">
                                {% if venta.metodopago == 'EFECTIVO' %}
                                üíµ
                                {% elif venta.metodopago == 'TARJETA' %}
                                üí≥
                                {% elif venta.metodopago == 'TRANSFERENCIA' %}
                                üè¶
                                {% endif %}
                                {{ venta.get_metodopago_display }}
                            </div>
                        </td>
                        <td class="purchase-status">
                            <span class="status-badge status-{{ venta.estadoventa|lower }}">
                                {{ venta.get_estadoventa_display }}
                            </span>
                        </td>
                        <td class="purchase-actions">
                            <a href="{% url 'detalle_venta' venta.ventaid %}" class="btn-detail">
                                <svg class="icon" viewBox="0 0 24 24" width="16" height="16">
                                    <path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/>
                                </svg>
                                Ver Detalles
                            </a>
                            <button class="btn-receipt" onclick="printReceipt({{ venta.ventaid }})">
                                <svg class="icon" viewBox="0 0 24 24" width="16" height="16">
                                    <path d="M19 8H5c-1.66 0-3 1.34-3 3v6h4v4h12v-4h4v-6c0-1.66-1.34-3-3-3zm-3 11H8v-5h8v5zm3-7c-.55 0-1-.45-1-1s.45-1 1-1 1 .45 1 1-.45 1-1 1zm-1-9H6v4h12V3z"/>
                                </svg>
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Paginaci√≥n -->
    {% if ventas.has_other_pages %}
    <div class="pagination">
        {% if ventas.has_previous %}
        <a href="?page=1" class="page-link first">&laquo; Primera</a>
        <a href="?page={{ ventas.previous_page_number }}" class="page-link prev">Anterior</a>
        {% endif %}

        {% for num in ventas.paginator.page_range %}
            {% if ventas.number == num %}
            <span class="page-link active">{{ num }}</span>
            {% elif num > ventas.number|add:'-3' and num < ventas.number|add:'3' %}
            <a href="?page={{ num }}" class="page-link">{{ num }}</a>
            {% endif %}
        {% endfor %}

        {% if ventas.has_next %}
        <a href="?page={{ ventas.next_page_number }}" class="page-link next">Siguiente</a>
        <a href="?page={{ ventas.paginator.num_pages }}" class="page-link last">√öltima &raquo;</a>
        {% endif %}
    </div>
    {% endif %}

    {% else %}
    <!-- Estado vac√≠o -->
    <div class="empty-state">
        <div class="empty-icon">üõí</div>
        <h2>No tienes compras realizadas</h2>
        <p>Visita nuestra secci√≥n de libros para realizar tu primera compra.</p>
        <div class="empty-actions">
            <a href="{% url 'libros' %}" class="btn-primary">
                <svg class="icon" viewBox="0 0 24 24" width="20" height="20">
                    <path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/>
                </svg>
                Explorar Libros
            </a>
            <a href="{% url 'inicio' %}" class="btn-secondary">
                <svg class="icon" viewBox="0 0 24 24" width="20" height="20">
                    <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/>
                </svg>
                Volver al Inicio
            </a>
        </div>
    </div>
    {% endif %}
</div>

<!-- Estilos CSS puro -->
<style>
/* Variables de color */
:root {
    --verde-principal: #28a745;
    --verde-claro: #d4edda;
    --verde-texto: #155724;
    --azul-principal: #007bff;
    --azul-claro: #e3f2fd;
    --amarillo: #ffc107;
    --amarillo-claro: #fff3cd;
    --rojo: #dc3545;
    --rojo-claro: #f8d7da;
    --gris-claro: #f8f9fa;
    --gris-medio: #e9ecef;
    --gris-borde: #dee2e6;
    --gris-texto: #6c757d;
    --gris-oscuro: #343a40;
    --blanco: #ffffff;
    --sombra: 0 4px 20px rgba(0, 0, 0, 0.1);
    --sombra-suave: 0 2px 10px rgba(0, 0, 0, 0.05);
}

/* Contenedor principal */
.container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
}

/* Encabezado de p√°gina */
.page-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 30px;
    padding-bottom: 20px;
    border-bottom: 2px solid var(--gris-borde);
}

.header-content {
    display: flex;
    align-items: center;
    gap: 20px;
}

.header-icon {
    font-size: 48px;
    background: linear-gradient(135deg, var(--verde-principal), #20c997);
    color: var(--blanco);
    width: 70px;
    height: 70px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: var(--sombra);
}

.page-header h1 {
    margin: 0;
    color: var(--gris-oscuro);
    font-size: 32px;
    font-weight: 700;
}

.subtitle {
    margin: 5px 0 0 0;
    color: var(--gris-texto);
    font-size: 16px;
}

.header-actions {
    display: flex;
    gap: 15px;
}

.btn-filter, .btn-export {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 10px 20px;
    border: none;
    border-radius: 6px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
}

.btn-filter {
    background: var(--gris-claro);
    color: var(--gris-oscuro);
    border: 1px solid var(--gris-borde);
}

.btn-filter:hover {
    background: var(--gris-medio);
}

.btn-export {
    background: var(--azul-principal);
    color: var(--blanco);
}

.btn-export:hover {
    background: #0056b3;
    transform: translateY(-2px);
}

.btn-filter .icon, .btn-export .icon {
    fill: currentColor;
}

/* Filtros */
.filters-container {
    background: var(--gris-claro);
    border-radius: 10px;
    padding: 25px;
    margin-bottom: 30px;
    box-shadow: var(--sombra-suave);
    display: none;
}

.filters-container.show {
    display: block;
    animation: slideDown 0.3s ease;
}

@keyframes slideDown {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.filters-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    align-items: end;
}

.filter-group {
    display: flex;
    flex-direction: column;
}

.filter-group label {
    margin-bottom: 8px;
    font-weight: 600;
    color: var(--gris-oscuro);
}

.filter-select {
    padding: 10px 15px;
    border: 1px solid var(--gris-borde);
    border-radius: 6px;
    background: var(--blanco);
    font-size: 14px;
    color: var(--gris-oscuro);
    cursor: pointer;
    transition: border-color 0.3s ease;
}

.filter-select:focus {
    outline: none;
    border-color: var(--azul-principal);
    box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
}

.filter-actions {
    display: flex;
    gap: 10px;
    align-items: flex-end;
}

.btn-apply, .btn-reset {
    padding: 10px 20px;
    border: none;
    border-radius: 6px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
}

.btn-apply {
    background: var(--verde-principal);
    color: var(--blanco);
}

.btn-apply:hover {
    background: #218838;
}

.btn-reset {
    background: var(--gris-claro);
    color: var(--gris-oscuro);
    border: 1px solid var(--gris-borde);
}

.btn-reset:hover {
    background: var(--gris-medio);
}

/* Estad√≠sticas */
.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.stat-card {
    background: var(--blanco);
    border-radius: 10px;
    padding: 25px;
    display: flex;
    align-items: center;
    gap: 20px;
    box-shadow: var(--sombra-suave);
    border: 1px solid var(--gris-borde);
    transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.stat-card:hover {
    transform: translateY(-5px);
    box-shadow: var(--sombra);
}

.stat-icon {
    font-size: 40px;
    width: 70px;
    height: 70px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--gris-claro);
    border-radius: 50%;
}

.stat-content h3 {
    margin: 0 0 10px 0;
    color: var(--gris-texto);
    font-size: 16px;
    font-weight: 600;
}

.stat-value {
    margin: 0;
    color: var(--gris-oscuro);
    font-size: 28px;
    font-weight: 700;
}

/* Tabla */
.table-container {
    background: var(--blanco);
    border-radius: 10px;
    overflow: hidden;
    box-shadow: var(--sombra);
    margin-bottom: 30px;
}

.table-responsive {
    overflow-x: auto;
}

.purchases-table {
    width: 100%;
    border-collapse: collapse;
    min-width: 800px;
}

.purchases-table thead {
    background: var(--gris-claro);
}

.purchases-table th {
    padding: 18px 15px;
    text-align: left;
    font-weight: 600;
    color: var(--gris-oscuro);
    border-bottom: 2px solid var(--gris-borde);
    position: relative;
}

.purchases-table th.text-left {
    text-align: left;
}

.purchases-table th.text-center {
    text-align: center;
}

.sort-btn {
    background: none;
    border: none;
    cursor: pointer;
    margin-left: 5px;
    font-size: 12px;
    color: var(--gris-texto);
    transition: color 0.3s ease;
}

.sort-btn:hover {
    color: var(--azul-principal);
}

.purchases-table td {
    padding: 18px 15px;
    border-bottom: 1px solid var(--gris-borde);
    vertical-align: middle;
}

.purchase-row:hover {
    background: var(--gris-claro);
}

.purchase-id {
    font-weight: 600;
    color: var(--gris-oscuro);
    font-family: monospace;
    font-size: 16px;
}

.purchase-date {
    color: var(--gris-texto);
    white-space: nowrap;
}

.purchase-total {
    font-weight: 700;
    color: var(--gris-oscuro);
    font-size: 18px;
}

.method-badge {
    display: inline-flex;
    align-items: center;
    gap: 5px;
    padding: 6px 12px;
    background: var(--gris-claro);
    border-radius: 20px;
    font-size: 14px;
    color: var(--gris-oscuro);
}

/* Badges de estado */
.status-badge {
    display: inline-block;
    padding: 6px 15px;
    border-radius: 20px;
    font-size: 14px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.status-completada {
    background: var(--verde-claro);
    color: var(--verde-texto);
}

.status-pendiente {
    background: var(--amarillo-claro);
    color: #856404;
}

.status-cancelada {
    background: var(--rojo-claro);
    color: #721c24;
}

/* Botones de acci√≥n */
.purchase-actions {
    display: flex;
    gap: 10px;
    justify-content: center;
}

.btn-detail, .btn-receipt {
    display: flex;
    align-items: center;
    gap: 5px;
    padding: 8px 15px;
    border: none;
    border-radius: 4px;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s ease;
    text-decoration: none;
}

.btn-detail {
    background: var(--azul-principal);
    color: var(--blanco);
}

.btn-detail:hover {
    background: #0056b3;
    transform: translateY(-2px);
}

.btn-receipt {
    background: var(--gris-claro);
    color: var(--gris-oscuro);
    padding: 8px;
}

.btn-receipt:hover {
    background: var(--gris-medio);
    transform: translateY(-2px);
}

.btn-detail .icon, .btn-receipt .icon {
    fill: currentColor;
}

/* Estado vac√≠o */
.empty-state {
    text-align: center;
    padding: 60px 20px;
    background: var(--blanco);
    border-radius: 10px;
    box-shadow: var(--sombra);
    margin: 40px 0;
}

.empty-icon {
    font-size: 80px;
    margin-bottom: 20px;
    display: inline-block;
    background: linear-gradient(135deg, #6c757d, #495057);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
}

.empty-state h2 {
    color: var(--gris-oscuro);
    margin: 0 0 15px 0;
    font-size: 28px;
}

.empty-state p {
    color: var(--gris-texto);
    margin: 0 0 30px 0;
    font-size: 18px;
    max-width: 500px;
    margin-left: auto;
    margin-right: auto;
}

.empty-actions {
    display: flex;
    gap: 15px;
    justify-content: center;
    flex-wrap: wrap;
}

.btn-primary, .btn-secondary {
    display: inline-flex;
    align-items: center;
    gap: 10px;
    padding: 14px 28px;
    border: none;
    border-radius: 6px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    text-decoration: none;
    min-width: 180px;
    justify-content: center;
}

.btn-primary {
    background: var(--verde-principal);
    color: var(--blanco);
}

.btn-primary:hover {
    background: #218838;
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
}

.btn-secondary {
    background: var(--gris-claro);
    color: var(--gris-oscuro);
    border: 1px solid var(--gris-borde);
}

.btn-secondary:hover {
    background: var(--gris-medio);
    transform: translateY(-2px);
}

.btn-primary .icon, .btn-secondary .icon {
    fill: currentColor;
}

/* Paginaci√≥n */
.pagination {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 5px;
    margin-top: 30px;
    flex-wrap: wrap;
}

.page-link {
    padding: 10px 15px;
    border: 1px solid var(--gris-borde);
    border-radius: 6px;
    color: var(--azul-principal);
    text-decoration: none;
    font-weight: 500;
    transition: all 0.3s ease;
    min-width: 40px;
    text-align: center;
}

.page-link:hover {
    background: var(--gris-claro);
    border-color: var(--azul-principal);
}

.page-link.active {
    background: var(--azul-principal);
    color: var(--blanco);
    border-color: var(--azul-principal);
}

.page-link.first, .page-link.last {
    padding: 10px 20px;
}

/* Responsive */
@media (max-width: 768px) {
    .container {
        padding: 15px;
    }
    
    .page-header {
        flex-direction: column;
        align-items: stretch;
        gap: 20px;
    }
    
    .header-content {
        flex-direction: column;
        text-align: center;
        gap: 15px;
    }
    
    .header-icon {
        align-self: center;
    }
    
    .page-header h1 {
        font-size: 24px;
    }
    
    .header-actions {
        justify-content: center;
        flex-wrap: wrap;
    }
    
    .stats-grid {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .stat-card {
        flex-direction: column;
        text-align: center;
        padding: 20px;
    }
    
    .purchases-table th,
    .purchases-table td {
        padding: 12px 8px;
        font-size: 14px;
    }
    
    .purchase-actions {
        flex-direction: column;
        gap: 5px;
    }
    
    .btn-detail, .btn-receipt {
        justify-content: center;
        padding: 6px 10px;
    }
    
    .empty-state {
        padding: 40px 15px;
    }
    
    .empty-icon {
        font-size: 60px;
    }
    
    .empty-state h2 {
        font-size: 22px;
    }
    
    .empty-state p {
        font-size: 16px;
    }
    
    .empty-actions {
        flex-direction: column;
    }
    
    .btn-primary, .btn-secondary {
        width: 100%;
    }
}

@media (max-width: 480px) {
    .stats-grid {
        grid-template-columns: 1fr;
    }
    
    .filters-grid {
        grid-template-columns: 1fr;
    }
    
    .filter-actions {
        flex-direction: column;
    }
    
    .btn-apply, .btn-reset {
        width: 100%;
    }
    
    .pagination {
        flex-direction: column;
        align-items: stretch;
    }
    
    .page-link {
        text-align: center;
    }
}
</style>

<script>
// Variables globales
let currentSort = { column: 'date', direction: 'desc' };
let currentFilters = { status: 'all', month: 'all', sort: 'newest' };

// Toggle de filtros
document.getElementById('filterToggle').addEventListener('click', function() {
    const filtersPanel = document.getElementById('filtersPanel');
    filtersPanel.classList.toggle('show');
    this.classList.toggle('active');
});

// Aplicar filtros
function applyFilters() {
    const statusFilter = document.getElementById('filterStatus').value;
    const monthFilter = document.getElementById('filterMonth').value;
    const sortFilter = document.getElementById('sortOrder').value;
    
    currentFilters = {
        status: statusFilter,
        month: monthFilter,
        sort: sortFilter
    };
    
    filterAndSortTable();
    
    // Mostrar notificaci√≥n
    showNotification('Filtros aplicados correctamente', 'success');
}

// Resetear filtros
function resetFilters() {
    document.getElementById('filterStatus').value = 'all';
    document.getElementById('filterMonth').value = 'all';
    document.getElementById('sortOrder').value = 'newest';
    
    currentFilters = { status: 'all', month: 'all', sort: 'newest' };
    
    filterAndSortTable();
    showNotification('Filtros restablecidos', 'info');
}

// Filtrar y ordenar tabla
function filterAndSortTable() {
    const rows = document.querySelectorAll('.purchase-row');
    let visibleRows = [];
    
    // Filtrar por estado
    rows.forEach(row => {
        let showRow = true;
        
        // Filtrar por estado
        if (currentFilters.status !== 'all' && 
            row.dataset.status !== currentFilters.status) {
            showRow = false;
        }
        
        // Filtrar por mes
        if (currentFilters.month !== 'all') {
            const rowDate = new Date(row.dataset.date);
            const rowMonth = rowDate.getMonth() + 1; // getMonth() es 0-indexed
            if (rowMonth.toString() !== currentFilters.month) {
                showRow = false;
            }
        }
        
        if (showRow) {
            visibleRows.push(row);
        }
        
        // Mostrar/ocultar fila
        row.style.display = showRow ? '' : 'none';
    });
    
    // Ordenar filas visibles
    sortRows(visibleRows, currentFilters.sort);
}

// Ordenar filas
function sortRows(rows, sortType) {
    const tbody = document.querySelector('.purchases-table tbody');
    
    // Crear array para ordenar
    const rowsArray = Array.from(rows);
    
    rowsArray.sort((a, b) => {
        switch(sortType) {
            case 'newest':
                return new Date(b.dataset.date) - new Date(a.dataset.date);
            case 'oldest':
                return new Date(a.dataset.date) - new Date(b.dataset.date);
            case 'total_high':
                return parseFloat(b.dataset.total) - parseFloat(a.dataset.total);
            case 'total_low':
                return parseFloat(a.dataset.total) - parseFloat(b.dataset.total);
            default:
                return 0;
        }
    });
    
    // Reordenar filas en el DOM
    rowsArray.forEach(row => {
        tbody.appendChild(row);
    });
}

// Exportar a CSV
function exportToCSV() {
    const rows = document.querySelectorAll('.purchase-row:not([style*="display: none"])');
    let csvContent = "data:text/csv;charset=utf-8,";
    
    // Encabezados
    csvContent += "ID Venta,Fecha,Total,M√©todo Pago,Estado\n";
    
    // Datos
    rows.forEach(row => {
        const id = row.querySelector('.purchase-id').textContent;
        const date = row.querySelector('.purchase-date').textContent;
        const total = row.querySelector('.purchase-total').textContent.replace('$', '');
        const method = row.querySelector('.method-badge').textContent;
        const status = row.querySelector('.status-badge').textContent;
        
        csvContent += `${id},${date},${total},${method},${status}\n`;
    });
    
    // Crear enlace de descarga
    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", "mis_compras.csv");
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    showNotification('CSV descargado correctamente', 'success');
}

// Imprimir recibo
function printReceipt(ventaId) {
    // Aqu√≠ implementar√≠as la l√≥gica para generar un recibo
    // Por ahora, redirigimos a la vista de detalles
    window.open(`/carrito/detalle/${ventaId}/?print=true`, '_blank');
}

// Notificaciones
function showNotification(message, type) {
    const notification = document.createElement('div');
    notification.className = `notification notification-${type}`;
    notification.textContent = message;
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 15px 25px;
        border-radius: 6px;
        color: white;
        font-weight: 500;
        z-index: 1000;
        animation: slideIn 0.3s ease;
    `;
    
    if (type === 'success') {
        notification.style.background = 'var(--verde-principal)';
    } else if (type === 'error') {
        notification.style.background = 'var(--rojo)';
    } else {
        notification.style.background = 'var(--azul-principal)';
    }
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => notification.remove(), 300);
    }, 3000);
}

// Inicializar
document.addEventListener('DOMContentLoaded', function() {
    // Configurar event listeners para ordenamiento
    document.querySelectorAll('.sort-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const column = this.dataset.sort;
            const direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            currentSort = { column, direction };
            // Aqu√≠ implementar√≠as la l√≥gica de ordenamiento
            showNotification(`Ordenando por ${column} (${direction})`, 'info');
        });
    });
    
    // Inicializar filtros
    filterAndSortTable();
});

// Animaciones CSS
const style = document.createElement('style');
style.textContent = `
@keyframes slideIn {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

@keyframes slideOut {
    from {
        transform: translateX(0);
        opacity: 1;
    }
    to {
        transform: translateX(100%);
        opacity: 0;
    }
}
`;
document.head.appendChild(style);
</script>
{% endblock %}